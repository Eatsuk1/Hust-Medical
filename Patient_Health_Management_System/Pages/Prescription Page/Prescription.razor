@page "/prescription"
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IPrescriptionService prescriptionService
@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@layout MainLayout

<AuthorizeView Context="contextAuthorize">
    <NotAuthorized>
        <MudText>Not Authorized</MudText>
    </NotAuthorized>
    <Authorized>
        <MudPaper Style="overflow:hidden; position:relative; margin-left:56px; margin-top:60px">
            <MudTable Items="@prescriptions" Hover="true" Bordered="true" Striped="true"
                      Filter="new Func<Domain.Models.Prescription, bool>(FilterS)" Breakpoint="Breakpoint.Sm" SortLabel="Sort By">

                <ToolBarContent>
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="() => ShowAdd()">Thêm</MudButton>
                    <MudSpacer />
                    <MudTextField Immediate="true" @bind-Value="searchS" T="string" Placeholder="Search"
                                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                                  Class="mt-0"></MudTextField>
                </ToolBarContent>

                <HeaderContent>
                    <MudTh>
                        <MudTableSortLabel SortBy="new Func<Domain.Models.Prescription, object>(x=>x.PrescriptionId)">
                            Mã đơn thuốc
                        </MudTableSortLabel>
                    </MudTh>
                    @*<MudTh>
                        <MudTableSortLabel SortBy="new Func<Domain.Models.Prescription, object>(x=>x.Name)">Tên bệnh nhân</MudTableSortLabel>
                    </MudTh>*@
                    <MudTh>Chức năng</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Mã đơn thuốc">@context.PrescriptionId</MudTd>
                    @*<MudTd DataLabel="Tên bệnh nhân">@context.Name</MudTd>*@
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Medium"
                                       OnClick="(e) => ShowUpdate(context.Id)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Medium"
                                       OnClick="(e) => ShowDelete(context.Id)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Info" Color="Color.Info" Size="Size.Medium" OnClick="(e) => ShowDetail(context.Id)" />
                    </MudTd>
                </RowTemplate>

                <PagerContent>
                    <MudTablePager />
                </PagerContent>

                <NoRecordsContent>
                    <MudText>Không tìm thấy dữ liệu</MudText>
                </NoRecordsContent>

                <LoadingContent>
                    <MudText>Loading...</MudText>
                </LoadingContent>

                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudPaper>
    </Authorized>
</AuthorizeView>


@code {
    private IEnumerable<Domain.Models.Prescription> prescriptions = new List<Domain.Models.Prescription>();
    private string searchS = "";

    protected override async Task OnInitializedAsync()
    {
        prescriptions = await prescriptionService.GetPrescriptions();
    }

    private async Task ShowDetail(string Id)
    {
        var parameter = new DialogParameters { ["Id"] = Id };
        var dialog = await DialogService.ShowAsync<PresDetailPopUp>("Thông tin đơn thuốc", parameter);
        var result = await dialog.Result;
    }

    private async Task ShowAdd()
    {
        NavigationManager.NavigateTo("/prescription/create");
    }

    private async Task ShowUpdate(string id)
    {
        var parameter = new DialogParameters { ["Id"] = id };
        var dialog = DialogService.Show<PresUpdatePopUp>("Sửa thông tin đơn thuốc", parameter);
        var result = await dialog.Result;
        await InvokeAsync(OnInitializedAsync);
    }

    private async Task ShowDelete(string id)
    {
        var parameter = new DialogParameters { ["Id"] = id};
        var dialog = DialogService.Show<PresDeletePopUp>("Xóa đơn thuốc", parameter);
        var result = await dialog.Result;
        await InvokeAsync(OnInitializedAsync);
    }

    private bool FilterS(Domain.Models.Prescription prescription) => FilterSearch(prescription, searchS);

    private bool FilterSearch(Domain.Models.Prescription prescription, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString)) return true;
        if (prescription.PrescriptionId.Contains(searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
        return false;
    }
}
