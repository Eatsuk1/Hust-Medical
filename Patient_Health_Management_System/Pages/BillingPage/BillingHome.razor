@page "/billing"
@attribute [Authorize(Roles = "Cashier")]
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IBillingService BillingService
@inject IPatientService PatientService
@inject IDialogService DialogService
@inject NavigationManager NavigationManager

<MudPaper Style="overflow:hidden; position:relative; margin-left:56px; margin-top:60px">
    <MudTable Items="billings" Hover="true" Bordered="true" Striped="true" Filter="new Func<Billing, bool>(FilterS)"
        Breakpoint="Breakpoint.Sm" SortLabel="SortBy">
        <ToolBarContent>
            <MudTextField Immediate="true" @bind-Value="searchS" T="string" Placeholder="Search"
                Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                Class="mt-0"></MudTextField>
        </ToolBarContent>

        <HeaderContent>
            <MudTh>Mã hoá đơn</MudTh>
            <MudTh>Mã bệnh nhân</MudTh>
            <MudTh>Tên bệnh nhân</MudTh>
            <MudTh>
                <MudTableSortLabel SortBy="new Func<Billing, object>(b => b.CreatedAt)">
                    Thời gian tạo
                </MudTableSortLabel>
            </MudTh>
            <MudTh>Tình trạng thanh toán</MudTh>
            <MudTh>Chức năng</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Mã hoá đơn">@context.BillId</MudTd>
            <MudTd DataLabel="Mã bệnh nhân">@patients.Where(p => p.Id.Equals(context.PatientId)).First().PatientId
            </MudTd>
            <MudTd DataLabel="Tên bệnh nhân">@patients.Where(p => p.Id.Equals(context.PatientId)).First().Name</MudTd>
            <MudTd DataLabel="Thời gian tạo">@context.CreatedAt.ToLocalTime().ToString("dd/MM/yyyy hh:mm tt")</MudTd>
            <MudTd DataLabel="Tình trạng thanh toán">
                <MudChip Color="context.IsPaid ? Color.Success : Color.Error">@(context.IsPaid ? "Đã thanh toán" : "Chưa thanh toán")</MudChip>
            </MudTd>
            <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Medium"
                                       OnClick="(e) => ShowUpdate(context)" />
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

@code {
    private IEnumerable<Billing> billings = new List<Billing>();
    private IEnumerable<Patient> patients = new List<Patient>();
    private string searchS = new string("");
    private string userId = new string("");

    protected override async Task OnInitializedAsync()
    {
        await GetUserId();
        var autoRefreshUI = new Timer((_) =>
        {
            InvokeAsync(async () =>
            {
                billings = await BillingService.GetBillings();
                patients = await PatientService.GetPatients();
                StateHasChanged();
            });
        }, null, 0, 10000);
    }

    private async Task ShowUpdate(Billing billing)
    {
        var parameter = new DialogParameters { ["Bill"] = billing, ["UserId"] = userId };
        var dialog = DialogService.Show<BillingUpdatePopUp>("Cập nhật hoá đơn", parameter);
        var result = await dialog.Result;
        await InvokeAsync(OnInitializedAsync);
    }

    private bool FilterS(Billing billing) => FilterSearch(billing, searchS);

    private bool FilterSearch(Billing billing, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (billing.BillId.ToString().Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (patients.Any(p => p.PatientId.Contains(searchString, StringComparison.OrdinalIgnoreCase)))
            return true;
        if (patients.Any(p => p.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase)))
            return true;
        return false;
    }

    private async Task GetUserId()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        userId = authState.User.Claims
        .Where(c => c.Type.Equals(ClaimTypes.NameIdentifier))
        .SingleOrDefault().Value;
    }
}
