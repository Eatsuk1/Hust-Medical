@page "/account"
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ProtectedLocalStorage ProtectedLocalStorage
@inject IAccountService AccountService
@inject IDialogService DialogService
@layout MainLayout



<MudPaper Style="overflow:hidden; position:relative; margin-top:60px">
    <MudTextField Label="Name" Value="@userResponse.Name" ReadOnly="true"></MudTextField>
    <MudTextField Label="Email" Value="@userResponse.Email" ReadOnly="true"></MudTextField>
    <MudAvatar Size="Size.Medium" Rounded="true">
        <MudImage Src="@userResponse.Picture"/>
    </MudAvatar>
</MudPaper>

@code{
    private string userId = new string("");

    private UserResponse userResponse = new UserResponse();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await GetUserId();
            var access_token = await ProtectedLocalStorage.GetAsync<string>("access_token");
            if (String.IsNullOrEmpty(access_token.Value) || AccountService.IsExpired(access_token.Value))
            {
                var auth0Token = await AccountService.TokenGenerator();
                await ProtectedLocalStorage.SetAsync("access_token", auth0Token.access_token);
                userResponse = await AccountService.GetUserResponseById(userId, access_token.Value);
            }
            else
            {
                userResponse = await AccountService.GetUserResponseById(userId, access_token.Value);
            }
            StateHasChanged();
        }
    }

    private async Task GetUserId()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var userClaim = authState.User.Claims;
        foreach (var item in userClaim)
        {
            if (item.Type == ClaimTypes.NameIdentifier)
            {
                userId = item.Value;
            }
        }
    }
}