@page "/medicalExamination"
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IMedicalExaminationService medicalExamService
@inject IDialogService DialogService
@layout MainLayout

<AuthorizeView Context="contextAuthorize">
    <NotAuthorized>
        <MudText>Not Authorized</MudText>
    </NotAuthorized>
    <Authorized>
        <MudPaper Style="overflow:hidden; position:relative; margin-left:56px">
            <MudTable Items="@medicalExaminations" Hover="true" Bordered="true" Striped="true"
                      Filter="new Func<Models.MedicalExamination, bool>(FilterS)" Breakpoint="Breakpoint.Sm" SortLabel="Sort By">

                <ToolBarContent>
                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="() => ShowAdd()">Thêm</MudButton>
                    <MudSpacer />
                    <MudTextField Immediate="true" @bind-Value="searchS" T="string" Placeholder="Search"
                                  Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium"
                                  Class="mt-0"></MudTextField>
                </ToolBarContent>

                <HeaderContent>
                    <MudTh>
                        <MudTableSortLabel SortBy="new Func<Models.MedicalExamination, object>(x=>x.MedicalExaminationId)">
                            Mã đơn khám
                        </MudTableSortLabel>
                    </MudTh>
                    @*<MudTh>
                    <MudTableSortLabel SortBy="new Func<Models.MedicalExamination, object>(x=>x.Name)">Tên bệnh nhân</MudTableSortLabel>
                    </MudTh>*@
                    <MudTh>Chức năng</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Mã đơn thuốc">@context.MedicalExaminationId</MudTd>
                    @*<MudTd DataLabel="Tên bệnh nhân">@context.Name</MudTd>*@
                    <MudTd>
                        <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Medium"
                                       OnClick="(e) => ShowUpdate(context.Id)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Medium"
                                       OnClick="(e) => ShowDelete(context.Id)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Info" Color="Color.Info" Size="Size.Medium" OnClick="(e) => ShowDetail(context.Id)" />
                    </MudTd>
                </RowTemplate>

                <PagerContent>
                    <MudTablePager />
                </PagerContent>

                <NoRecordsContent>
                    <MudText>Không tìm thấy dữ liệu</MudText>
                </NoRecordsContent>

                <LoadingContent>
                    <MudText>Loading...</MudText>
                </LoadingContent>

                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudPaper>
    </Authorized>
</AuthorizeView>


@code {
    private IEnumerable<Models.MedicalExamination> medicalExaminations = new List<Models.MedicalExamination>();
    private string searchS = "";

    protected override async Task OnInitializedAsync()
    {
        medicalExaminations = await medicalExamService.GetMedicalExaminations();
    }

    private async Task ShowDetail(string Id)
    {
        var parameter = new DialogParameters { ["Id"] = Id };
        var dialog = await DialogService.ShowAsync<MedicalExDetailPopUp>("Thông tin đơn khám", parameter);
        var result = await dialog.Result;
    }

    private async Task ShowAdd()
    {
        var dialog = DialogService.Show<MedicalExCreatePopUp>("Thêm đơn khám");
        var result = await dialog.Result;
        await InvokeAsync(OnInitializedAsync);
    }

    private async Task ShowUpdate(string id)
    {
        var parameter = new DialogParameters { ["Id"] = id };
        var dialog = DialogService.Show<MedicalExUpdatePopUp>("Sửa thông tin đơn khám", parameter);
        var result = await dialog.Result;
        await InvokeAsync(OnInitializedAsync);
    }

    private async Task ShowDelete(string id)
    {
        var parameter = new DialogParameters { ["Id"] = id };
        var dialog = DialogService.Show<MedicalExDeletePopUp>("Xóa đơn khám", parameter);
        var result = await dialog.Result;
        await InvokeAsync(OnInitializedAsync);
    }

    private bool FilterS(Models.MedicalExamination medicalExam) => FilterSearch(medicalExam, searchS);

    private bool FilterSearch(Models.MedicalExamination medicalExam, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString)) return true;
        if (medicalExam.MedicalExaminationId.Contains(searchString, StringComparison.OrdinalIgnoreCase) == true) return true;
        return false;
    }
}